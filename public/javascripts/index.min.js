/** 2017 ©HEXSON */
(function(){angular.module("app",[]).run(["$rootScope","$timeout",function(a,c){var b=a.chat={apiRest:"http://localhost:4000/api/",login:function(d,e){var f=this.toastr;if(!d){return f("昵称不能为空")}if(/\s/.test(d)){return f("昵称不能包含空格")}if(!e){return f("密码不能为空")}this.post("login",{nickname:d,password:md5(e)},function(g){if(g.code){b.init(b.vm,d,g.token)}else{b.clearLocalStorage();f(g.msg);b.init(b.vm)}})},signin:function(d,e,g){var f=this.toastr;if(!d){return f("昵称不能为空")}if(/\s/.test(d)){return f("昵称不能包含空格")}if(!e){return f("密码不能为空")}if(g!=e){return f("两次密码不一致")}this.post("signin",{nickname:d,password:md5(e),passwordagn:md5(g)},function(h){if(h.code){b.init(b.vm,d,h.token)}else{b.clearLocalStorage();f(h.msg);b.init(b.vm)}})},get:function(f,d,g,e){this.ajax.call(this,"GET",f,d,g,e)},post:function(f,d,g,e){this.ajax.call(this,"POST",f,d,g,e)},ajax:function(g,f,d,i,e){var h=this;$.ajax({type:g,url:(f.indexOf("http")>=0?f:h.apiRest+f),data:d,dataType:"json",success:i,error:e||function(j){console.log(j)}})},toastr:function(f,e){var g="toastr_"+new Date().getTime().toString(16)+Math.random().toString().substr(3,6);var d='<div id="'+g+'" class="toastr toastr-animation"><span>'+f+"</span></div>";$("body").append(d);setTimeout(function(){$("#"+g).fadeOut();setTimeout(function(){$("#"+g).remove()},500)},e||2000)},storage:window.localStorage,getLocalStorage:function(d){return this.storage.getItem(d)},setLocalStorage:function(d,e){this.storage.setItem(d,e)},delLocalStorage:function(d){this.storage.removeItem(d)},clearLocalStorage:function(){this.storage.clear()},showLoginView:function(){$(".webim-sign").show();$("#signinView,.webim-wrap").hide();$("#loginView").show()},showSigninView:function(){$(".webim-sign").show();$("#loginView,.webim-wrap").hide();$("#signinView").show()},showChat:function(){$(".webim-sign").hide();$(".webim-wrap").show()},logout:function(){this.socket.disconnect();this.showLoginView()},init:function(e,g,d){if(g&&d){this.setLocalStorage("account",g);this.setLocalStorage("token",d)}if(!this.getLocalStorage("token")){this.showLoginView();return}var f=this;this.vm=e;this.socket=io.connect("http://localhost:4001");this.socket.emit("login",{token:this.getLocalStorage("token")});this.socket.on("login",function(h){console.log("login: ",h);if(h){e.user=h;c(angular.noop);f.socket.emit("friends",h.friend_list.split(","));b.showChat()}else{b.showLoginView()}});this.socket.on("friends",function(h){console.log("friends: ",h);if(h){e.friends=h}else{e.friends=[];e.not_friends=true}c(angular.noop)});this.socket.on("add",function(i){console.log("add: ",i);if(typeof i==="string"){b.toastr(i)}else{var h=e.msgs||[];h.push(i);e.msgs=h;c(angular.noop)}});this.socket.on("addAgree",function(h){console.log("addAgree: ",h);if(typeof h==="string"){b.toastr(h)}else{e.friends=e.friends||[];e.friends.push(h);e.user.friend_list+=","+h.id;b.toastr("已成为好友啦");c(angular.noop)}});this.socket.on("addCancel",function(h){console.log("addCancel: ",h);b.toastr(h)});this.socket.on("getmsg",function(h){console.log("getmsg: ",h);e.msgList=h;c(angular.noop);c(function(){$(".im-cvs-cont").scrollTop($(".im-cvs-cont")[0].scrollHeight)})});this.socket.on("message",function(j){console.log("message: ",j);console.info(j.from==e.user.id);if(j.from==e.user.id){e.msgList.push(j);for(var h=0;h<e.friends.length;h++){if(e.friends[h].id==j.to){e.friends[h].content=j.content;e.friends[h].time=j.send_at;break}}e.msg=null}if(j.to=e.user.id){if(j.from==e.toId){e.msgList.push(j)}else{for(var h=0;h<e.friends.length;h++){if(e.friends[h].id==j.from){e.friends[h].content=j.content;e.friends[h].time=j.send_at;e.friends[h].count=e.friends[h].count?(+e.friends[h].count+1):1;break}}}}c(angular.noop);c(function(){$(".im-cvs-cont").scrollTop($(".im-cvs-cont")[0].scrollHeight)})})}}}]).controller("webim",["$scope","$rootScope","$timeout",function(d,a,c){var e={cursorcolor:"#d1d7e6",cursorborder:"0"};$(".im-f-list").niceScroll(e);$(".im-cvs-cont").niceScroll(e);var b=a.chat;b.init(d);d.loginaccount=b.getLocalStorage("account");d.tFocusBlur=function(){d.sendBg=!d.sendBg};d.signinGo=function(){b.showSigninView()};d.loginGo=function(){b.showLoginView()};d.login=function(f){if(f&&f.keyCode!==13){return}b.login(d.loginaccount,d.loginpassword)};d.signin=function(f){if(f&&f.keyCode!==13){return}b.signin(d.signinaccount,d.signinpassword,d.signinpasswordagn)};d.logout=function(){var f=b.getLocalStorage("account");b.clearLocalStorage();d.loginaccount=f;b.setLocalStorage("account",f);b.logout()};d.find=function(f){if(f&&f.keyCode!==13){return}if(!d.findUser){return b.toastr("搜索昵称不能为空")}b.get("finduser",{nickname:d.findUser,fuzzy:true},function(g){d.searchShow=true;d.searchList=g.users;c(angular.noop)})};d.searchHide=function(){d.findUser=null;d.searchShow=false};d.add=function(f,g){if($(f.target).html()=="已发送"){return b.toastr("好友申请请求已发送")}$(f.target).html("已发送");b.socket.emit("add",g,d.user)};d.addAgree=function(g,f){d.msgs.splice(f,1);b.socket.emit("addAgree",d.user.id,g)};d.addCancel=function(g,f){d.msgs.splice(f,1);
b.socket.emit("addCancel",g)};d.itemFocus=function(f){d.itemcls={};d.itemcls[f.id]=true;d.toId=f.id;d.toName=f.nickname;d.toAvatar=f.avatar;b.socket.emit("getmsg",d.user.id,f.id);setTimeout(function(){$("textarea").trigger("focus")},10)};d.replace=function(f){if(f&&f.keyCode==13){f.preventDefault()}};d.send=function(f){if(f&&f.keyCode!==13){return}if(!d.msg){return b.toastr("发送内容不能为空")}b.socket.emit("message",d.user.id,d.toId,d.msg)}}])})();